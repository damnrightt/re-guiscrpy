name: Release
on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  release:
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        platform: [windows-latest]

    runs-on: ${{ matrix.platform }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-msvc

      - name: Install dependencies (Linux)
        if: matrix.platform == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.0-dev libappindicator3-dev librsvg2-dev patchelf

      - name: Install project dependencies
        run: npm install

      - name: Build the app
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tagName: ${{ github.ref_name }}
          releaseName: 'ReGUI Scrpy ${{ github.ref_name }}'
          releaseBody: 'See the assets to download this version and install.'
          releaseDraft: false
          prerelease: false

      - name: Create Portable Zip (Windows)
        if: matrix.platform == 'windows-latest'
        shell: powershell
        run: |
          # 1. Download scrcpy binary
          Invoke-WebRequest -Uri "https://github.com/Genymobile/scrcpy/releases/download/v2.7/scrcpy-win64-v2.7.zip" -OutFile "scrcpy.zip"
          Expand-Archive scrcpy.zip -DestinationPath scrcpy-bin
          
          # 2. Prepare portable folder
          $portableFolder = "ReGUI-Scrpy-Portable-${{ github.ref_name }}"
          New-Item -ItemType Directory -Force -Path $portableFolder
          
          # 3. Copy scrcpy content to root of portable folder
          Copy-Item "scrcpy-bin/scrcpy-win64-v2.7/*" -Destination $portableFolder -Recurse
          
          # 4. Copy our built exe to the portable folder
          # Note: Tauri outputs to target/release/regui-scrpy.exe
          Copy-Item "src-tauri/target/release/regui-scrpy.exe" -Destination "$portableFolder/ReGUI-Scrpy.exe"
          
          # 5. Create Zip
          Compress-Archive -Path "$portableFolder" -DestinationPath "$portableFolder.zip"

      - name: Upload Portable Zip
        if: matrix.platform == 'windows-latest'
        uses: softprops/action-gh-release@v1
        with:
          files: ReGUI-Scrpy-Portable-${{ github.ref_name }}.zip
